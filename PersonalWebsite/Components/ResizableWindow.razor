@using Microsoft.JSInterop
@implements IAsyncDisposable

<div class="window @(IsActive ? "active" : "") @(IsMaximized ? "maximized" : "")" style="width: @(Width)px; height: @(Height)px; top: @(Y)px; left: @(X)px; z-index: @ZIndex;" @ref="windowElement">
    <div class="window-header" @onmousedown="StartDrag">
        <div class="window-title">@Title</div>
        <div class="window-controls">
            <button class="window-button minimize" @onclick="OnMinimize">_</button>
            <button class="window-button maximize" @onclick="OnMaximize">□</button>
            <button class="window-button close" @onclick="OnClose">×</button>
        </div>
    </div>
    <div class="window-content">
        @ChildContent
    </div>
    <div class="resize-handle" @onmousedown="StartResize"></div>
</div>

@code {
    [Parameter]
    public string Title { get; set; } = "Window";

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public int X { get; set; } = 50;

    [Parameter]
    public int Y { get; set; } = 50;

    [Parameter]
    public int Width { get; set; } = 600;

    [Parameter]
    public int Height { get; set; } = 400;

    [Parameter]
    public int ZIndex { get; set; } = 1;

    [Parameter]
    public bool IsActive { get; set; } = true;
    
    [Parameter]
    public bool IsMaximized { get; set; } = false;

    [Parameter]
    public EventCallback OnMinimize { get; set; }

    [Parameter]
    public EventCallback OnMaximize { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<WindowPosition> OnPositionChanged { get; set; }

    private ElementReference windowElement;
    private DotNetObjectReference<ResizableWindow>? objRef;
    private IJSObjectReference? module;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/window.js");
            await module.InvokeVoidAsync("initializeWindow", windowElement, objRef);
        }
    }

    private async Task StartDrag(MouseEventArgs e)
    {
        if (!IsMaximized)
        {
            await module!.InvokeVoidAsync("startDrag", e.ClientX, e.ClientY);
        }
    }

    private async Task StartResize(MouseEventArgs e)
    {
        if (!IsMaximized)
        {
            await module!.InvokeVoidAsync("startResize", e.ClientX, e.ClientY);
        }
    }

    [JSInvokable]
    public async Task UpdatePosition(int x, int y, int width, int height)
    {
        X = x;
        Y = y;
        Width = width;
        Height = height;

        await OnPositionChanged.InvokeAsync(new WindowPosition { X = x, Y = y, Width = width, Height = height });
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (module is not null)
            {
                await module.DisposeAsync();
            }
            
            objRef?.Dispose();
        }
        catch (Exception)
        {
            // Ignore disposal exceptions
        }
    }

    public class WindowPosition
    {
        public int X { get; set; }
        public int Y { get; set; }
        public int Width { get; set; }
        public int Height { get; set; }
    }
} 